<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Music</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .title {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .visualizer {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .frequency-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 3px solid rgba(255,255,255,0.3);
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.1);
        }
        
        .frequency-text {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .acceleration-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .acceleration-bars {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .axis-display {
            text-align: center;
        }
        
        .axis-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .axis-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .axis-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .axis-bar-fill {
            height: 100%;
            transition: width 0.1s ease;
        }

        .drum-triggers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .drum-indicator {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .drum-indicator.active {
            background: rgba(255,215,0,0.8);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255,215,0,0.6);
        }

        .drum-name {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .drum-threshold {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        .controls {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .play-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .btn-play {
            width: 70px;
            height: 70px;
            background: #10b981;
        }
        
        .btn-play.playing {
            background: #ef4444;
        }
        
        .btn-settings {
            width: 50px;
            height: 50px;
            background: #6b7280;
        }
        
        .settings {
            display: none;
        }
        
        .settings.show {
            display: block;
        }
        
        .setting-group {
            margin-bottom: 15px;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #6b7280;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: #6b7280;
            color: white;
            font-size: 1rem;
        }
        
        .instructions {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 15px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
        }
        
        .instructions ul {
            list-style: none;
        }
        
        .instructions li {
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
        }

        .debug-info {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 10px;
            margin-top: 20px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .current-instrument {
            font-size: 1.5rem;
            margin-bottom: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üéµ Motion Music</h1>
        
        <div class="status" id="status">
            Appuyez sur Play pour commencer
        </div>
        
        <div class="visualizer">
            <div class="current-instrument" id="currentInstrument">üéπ Piano</div>
            <div class="frequency-circle" id="frequencyCircle">
                <div class="frequency-text" id="frequencyText">440 Hz</div>
                <div class="acceleration-text" id="accelerationText">0.0 m/s¬≤</div>
            </div>
            
            <div class="acceleration-bars">
                <div class="axis-display">
                    <div class="axis-label">X</div>
                    <div class="axis-value" id="xValue">0.0</div>
                    <div class="axis-bar">
                        <div class="axis-bar-fill" id="xBar" style="background: #ef4444; width: 0%"></div>
                    </div>
                </div>
                <div class="axis-display">
                    <div class="axis-label">Y</div>
                    <div class="axis-value" id="yValue">0.0</div>
                    <div class="axis-bar">
                        <div class="axis-bar-fill" id="yBar" style="background: #10b981; width: 0%"></div>
                    </div>
                </div>
                <div class="axis-display">
                    <div class="axis-label">Z</div>
                    <div class="axis-value" id="zValue">0.0</div>
                    <div class="axis-bar">
                        <div class="axis-bar-fill" id="zBar" style="background: #3b82f6; width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="drum-triggers">
                <div class="drum-indicator" id="kickIndicator">
                    <div class="drum-name">ü•Å Kick</div>
                    <div class="drum-threshold">Seuil: 3.0</div>
                </div>
                <div class="drum-indicator" id="snareIndicator">
                    <div class="drum-name">üî• Snare</div>
                    <div class="drum-threshold">Seuil: 5.0</div>
                </div>
                <div class="drum-indicator" id="hihatIndicator">
                    <div class="drum-name">‚ö° Hi-Hat</div>
                    <div class="drum-threshold">Seuil: 2.0</div>
                </div>
                <div class="drum-indicator" id="crashIndicator">
                    <div class="drum-name">üí• Crash</div>
                    <div class="drum-threshold">Seuil: 8.0</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="play-controls">
                <button class="btn btn-play" id="playBtn">‚ñ∂Ô∏è</button>
                <button class="btn btn-settings" id="settingsBtn">‚öôÔ∏è</button>
            </div>
            
            <div class="settings" id="settings">
                <div class="setting-group">
                    <label class="setting-label">Volume: <span id="volumeLabel">30%</span></label>
                    <input type="range" class="slider" id="volumeSlider" min="0" max="100" value="30">
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Sensibilit√©: <span id="sensitivityLabel">50</span></label>
                    <input type="range" class="slider" id="sensitivitySlider" min="10" max="100" value="50">
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Instrument:</label>
                    <select class="select" id="instrumentSelect">
                        <option value="piano">üéπ Piano</option>
                        <option value="guitar">üé∏ Guitare</option>
                        <option value="trumpet">üé∫ Trompette</option>
                        <option value="violin">üéª Violon</option>
                        <option value="saxophone">üé∑ Saxophone</option>
                        <option value="flute">ü™à Fl√ªte</option>
                        <option value="bass">üé∏ Basse</option>
                        <option value="organ">‚õ™ Orgue</option>
                        <option value="kick">ü•Å Kick Drum</option>
                        <option value="snare">üî• Snare Drum</option>
                        <option value="hihat">‚ö° Hi-Hat</option>
                        <option value="crash">üí• Crash Cymbal</option>
                        <option value="drumkit">ü•Å Kit Complet</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>Comment utiliser :</h3>
            <ul>
                <li>‚Ä¢ Appuyez sur Play pour commencer</li>
                <li>‚Ä¢ Bougez votre t√©l√©phone dans tous les sens</li>
                <li>‚Ä¢ Plus vous bougez fort, plus le son est aigu</li>
                <li>‚Ä¢ Les percussions se d√©clenchent selon l'intensit√©</li>
                <li>‚Ä¢ Changez d'instrument pour varier les plaisirs</li>
            </ul>
        </div>

        <div class="debug-info" id="debugInfo">
            Capteurs: En attente...
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // Variables globales
        let isPlaying = false;
        let currentSynth = null;
        let drumSynths = {};
        let frequency = 440;
        let volume = 0.3;
        let sensitivity = 50;
        let currentInstrument = 'piano';
        let permissionGranted = false;
        let acceleration = { x: 0, y: 0, z: 0 };
        let totalAcceleration = 0;
        let lastUpdate = 0;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        let noteTimeout = null;
        let lastDrumTrigger = {};

        // Configuration des seuils de percussion (multipli√© par la sensibilit√©)
        const drumThresholds = {
            kick: 3.0,
            snare: 5.0,
            hihat: 2.0,
            crash: 8.0
        };

        // Configuration des instruments avec Tone.js
        const instruments = {
            piano: () => new Tone.Sampler({
                urls: {
                    C4: "C4.mp3",
                    "D#4": "Ds4.mp3",
                    "F#4": "Fs4.mp3",
                    "A4": "A4.mp3",
                },
                release: 1,
                baseUrl: "https://tonejs.github.io/audio/salamander/"
            }),
            guitar: () => new Tone.PluckSynth({
                attackNoise: 1,
                dampening: 4000,
                resonance: 0.9
            }),
            trumpet: () => new Tone.Synth({
                oscillator: {
                    type: "sawtooth"
                },
                envelope: {
                    attack: 0.1,
                    decay: 0.2,
                    sustain: 0.3,
                    release: 0.8
                }
            }),
            violin: () => new Tone.Synth({
                oscillator: {
                    type: "sawtooth"
                },
                envelope: {
                    attack: 0.2,
                    decay: 0.1,
                    sustain: 0.9,
                    release: 1.2
                },
                filter: {
                    Q: 6,
                    type: "lowpass",
                    rolloff: -24
                }
            }),
            saxophone: () => new Tone.Synth({
                oscillator: {
                    type: "square"
                },
                envelope: {
                    attack: 0.1,
                    decay: 0.3,
                    sustain: 0.8,
                    release: 0.5
                }
            }),
            flute: () => new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.2,
                    decay: 0.1,
                    sustain: 0.2,
                    release: 2
                }
            }),
            bass: () => new Tone.MonoSynth({
                oscillator: {
                    type: "square"
                },
                envelope: {
                    attack: 0.1,
                    decay: 0.3,
                    sustain: 0.4,
                    release: 1.2
                },
                filter: {
                    Q: 2,
                    type: "lowpass",
                    rolloff: -12
                }
            }),
            organ: () => new Tone.Synth({
                oscillator: {
                    type: "fat sawtooth"
                },
                envelope: {
                    attack: 0.02,
                    decay: 0.1,
                    sustain: 0.9,
                    release: 0.4
                }
            }),
            // Percussions
            kick: () => new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 10,
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.4,
                    sustain: 0.01,
                    release: 1.4,
                    attackCurve: "exponential"
                }
            }),
            snare: () => new Tone.NoiseSynth({
                noise: {
                    type: "white"
                },
                envelope: {
                    attack: 0.005,
                    decay: 0.1,
                    sustain: 0.0
                }
            }),
            hihat: () => new Tone.MetalSynth({
                frequency: 200,
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    release: 0.2
                },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }),
            crash: () => new Tone.MetalSynth({
                frequency: 300,
                envelope: {
                    attack: 0.001,
                    decay: 1.4,
                    release: 3
                },
                harmonicity: 3.1,
                modulationIndex: 16,
                resonance: 2000,
                octaves: 1
            }),
            drumkit: () => null // Kit complet g√©r√© s√©par√©ment
        };

        // √âl√©ments DOM
        const playBtn = document.getElementById('playBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settings = document.getElementById('settings');
        const status = document.getElementById('status');
        const frequencyCircle = document.getElementById('frequencyCircle');
        const frequencyText = document.getElementById('frequencyText');
        const accelerationText = document.getElementById('accelerationText');
        const currentInstrumentEl = document.getElementById('currentInstrument');
        const xValue = document.getElementById('xValue');
        const yValue = document.getElementById('yValue');
        const zValue = document.getElementById('zValue');
        const xBar = document.getElementById('xBar');
        const yBar = document.getElementById('yBar');
        const zBar = document.getElementById('zBar');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeLabel = document.getElementById('volumeLabel');
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const sensitivityLabel = document.getElementById('sensitivityLabel');
        const instrumentSelect = document.getElementById('instrumentSelect');
        const debugInfo = document.getElementById('debugInfo');

        // Indicateurs de percussion
        const kickIndicator = document.getElementById('kickIndicator');
        const snareIndicator = document.getElementById('snareIndicator');
        const hihatIndicator = document.getElementById('hihatIndicator');
        const crashIndicator = document.getElementById('crashIndicator');

        // Fonction de debug
        function updateDebugInfo(message) {
            debugInfo.textContent = `Debug: ${message}`;
        }

        // Initialiser l'audio avec Tone.js
        async function initAudio() {
            try {
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                    updateDebugInfo('Tone.js initialis√©');
                }
                createInstrument();
                createDrumKit();
            } catch (error) {
                updateDebugInfo('Erreur audio: ' + error.message);
            }
        }

        // Cr√©er le kit de percussion
        function createDrumKit() {
            // Nettoyer les anciens synths
            Object.values(drumSynths).forEach(synth => {
                if (synth) synth.dispose();
            });
            drumSynths = {};

            // Cr√©er chaque percussion
            for (const drumType of ['kick', 'snare', 'hihat', 'crash']) {
                drumSynths[drumType] = instruments[drumType]();
                drumSynths[drumType].volume.value = Tone.gainToDb(volume);
                drumSynths[drumType].toDestination();
            }
        }

        // Cr√©er l'instrument s√©lectionn√©
        function createInstrument() {
            if (currentSynth) {
                currentSynth.dispose();
            }
            
            if (currentInstrument === 'drumkit') {
                currentSynth = null; // Pas de synth principal pour le kit complet
            } else if (instruments[currentInstrument]) {
                currentSynth = instruments[currentInstrument]();
                if (currentSynth) {
                    currentSynth.volume.value = Tone.gainToDb(volume);
                    currentSynth.toDestination();
                }
            }
            
            updateDebugInfo(`Instrument cr√©√©: ${currentInstrument}`);
        }

        // Convertir fr√©quence en note
        function frequencyToNote(freq) {
            const A4 = 440;
            const C0 = A4 * Math.pow(2, -4.75);
            
            if (freq > C0) {
                const h = Math.round(12 * Math.log2(freq / C0));
                const octave = Math.floor(h / 12);
                const n = h % 12;
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                return notes[n] + octave;
            }
            return 'C4';
        }

        // D√©clencher une percussion
        function triggerDrum(drumType, accel) {
            const now = Date.now();
            if (lastDrumTrigger[drumType] && now - lastDrumTrigger[drumType] < 200) return;
            
            lastDrumTrigger[drumType] = now;
            
            if (drumSynths[drumType]) {
                try {
                    if (drumType === 'kick') {
                        drumSynths[drumType].triggerAttackRelease('C1', '8n');
                    } else if (drumType === 'snare') {
                        drumSynths[drumType].triggerAttackRelease('8n');
                    } else {
                        drumSynths[drumType].triggerAttackRelease('8n');
                    }
                    
                    // Animation visuelle
                    const indicator = document.getElementById(drumType + 'Indicator');
                    if (indicator) {
                        indicator.classList.add('active');
                        setTimeout(() => indicator.classList.remove('active'), 300);
                    }
                } catch (error) {
                    console.error(`Erreur percussion ${drumType}:`, error);
                }
            }
        }

        // V√©rifier les seuils de percussion
        function checkDrumTriggers() {
            const sensitivityFactor = sensitivity / 50; // Normaliser la sensibilit√©
            
            // V√©rifier chaque type de percussion
            for (const [drumType, baseThreshold] of Object.entries(drumThresholds)) {
                const adjustedThreshold = baseThreshold * sensitivityFactor;
                
                if (totalAcceleration > adjustedThreshold) {
                    triggerDrum(drumType, totalAcceleration);
                }
            }
            
            // Mettre √† jour l'affichage des seuils
            document.querySelector('#kickIndicator .drum-threshold').textContent = 
                `Seuil: ${(drumThresholds.kick * sensitivityFactor).toFixed(1)}`;
            document.querySelector('#snareIndicator .drum-threshold').textContent = 
                `Seuil: ${(drumThresholds.snare * sensitivityFactor).toFixed(1)}`;
            document.querySelector('#hihatIndicator .drum-threshold').textContent = 
                `Seuil: ${(drumThresholds.hihat * sensitivityFactor).toFixed(1)}`;
            document.querySelector('#crashIndicator .drum-threshold').textContent = 
                `Seuil: ${(drumThresholds.crash * sensitivityFactor).toFixed(1)}`;
        }

        // Demander permission pour capteurs (iOS 13+)
        async function requestPermission() {
            updateDebugInfo('Demande de permission...');
            
            if (isIOS && typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceMotionEvent.requestPermission();
                    permissionGranted = permission === 'granted';
                    updateDebugInfo(`Permission iOS: ${permission}`);
                    return permissionGranted;
                } catch (error) {
                    updateDebugInfo('Erreur permission iOS: ' + error.message);
                    return false;
                }
            } else {
                permissionGranted = true;
                updateDebugInfo('Permission accord√©e (non-iOS)');
                return true;
            }
        }

        // G√©rer les donn√©es de mouvement
        function handleMotion(event) {
            const now = Date.now();
            if (now - lastUpdate < 50) return;
            lastUpdate = now;

            try {
                const accel = event.acceleration || event.accelerationIncludingGravity;
                
                if (accel) {
                    acceleration.x = accel.x || 0;
                    acceleration.y = accel.y || 0;
                    acceleration.z = accel.z || 0;
                    
                    totalAcceleration = Math.sqrt(
                        acceleration.x * acceleration.x + 
                        acceleration.y * acceleration.y + 
                        acceleration.z * acceleration.z
                    );
                    
                    if (!event.acceleration && event.accelerationIncludingGravity) {
                        totalAcceleration = Math.max(0, totalAcceleration - 9.8);
                    }
                    
                    const normalizedAccel = Math.min(totalAcceleration / 10, 1);
                    frequency = 200 + (normalizedAccel * sensitivity * 10);
                    
                    updateDisplay();
                    
                    // D√©clencher les percussions selon les seuils
                    if (currentInstrument === 'drumkit' || ['kick', 'snare', 'hihat', 'crash'].includes(currentInstrument)) {
                        checkDrumTriggers();
                    }
                    
                    // Jouer la note pour les instruments m√©lodiques
                    if (!['drumkit', 'kick', 'snare', 'hihat', 'crash'].includes(currentInstrument)) {
                        playNote();
                    } else if (['kick', 'snare', 'hihat', 'crash'].includes(currentInstrument)) {
                        // Pour un instrument de percussion sp√©cifique
                        const sensitivityFactor = sensitivity / 50;
                        const adjustedThreshold = drumThresholds[currentInstrument] * sensitivityFactor;
                        if (totalAcceleration > adjustedThreshold) {
                            triggerDrum(currentInstrument, totalAcceleration);
                        }
                    }
                    
                    updateDebugInfo(`Mouvement: ${totalAcceleration.toFixed(2)} m/s¬≤`);
                }
            } catch (error) {
                updateDebugInfo('Erreur motion: ' + error.message);
            }
        }

        // Alternative avec DeviceOrientationEvent
        function handleOrientation(event) {
            const now = Date.now();
            if (now - lastUpdate < 100) return;
            lastUpdate = now;

            try {
                const alpha = event.alpha || 0;
                const beta = event.beta || 0;
                const gamma = event.gamma || 0;
                
                acceleration.x = gamma / 90 * 5;
                acceleration.y = beta / 90 * 5;
                acceleration.z = alpha / 180 * 5;
                
                totalAcceleration = Math.sqrt(
                    acceleration.x * acceleration.x + 
                    acceleration.y * acceleration.y + 
                    acceleration.z * acceleration.z
                );
                
                const normalizedAccel = Math.min(totalAcceleration / 5, 1);
                frequency = 200 + (normalizedAccel * sensitivity * 8);
                
                updateDisplay();
                
                // D√©clencher les percussions selon les seuils
                if (currentInstrument === 'drumkit' || ['kick', 'snare', 'hihat', 'crash'].includes(currentInstrument)) {
                    checkDrumTriggers();
                }
                
                // Jouer la note pour les instruments m√©lodiques
                if (!['drumkit', 'kick', 'snare', 'hihat', 'crash'].includes(currentInstrument)) {
                    playNote();
                } else if (['kick', 'snare', 'hihat', 'crash'].includes(currentInstrument)) {
                    // Pour un instrument de percussion sp√©cifique
                    const sensitivityFactor = sensitivity / 50;
                    const adjustedThreshold = drumThresholds[currentInstrument] * sensitivityFactor;
                    if (totalAcceleration > adjustedThreshold) {
                        triggerDrum(currentInstrument, totalAcceleration);
                    }
                }
                
                updateDebugInfo(`Orientation: Œ±${alpha.toFixed(0)}¬∞ Œ≤${beta.toFixed(0)}¬∞ Œ≥${gamma.toFixed(0)}¬∞`);
            } catch (error) {
                updateDebugInfo('Erreur orientation: ' + error.message);
            }
        }

        // Jouer une note
        function playNote() {
            if (!isPlaying || !currentSynth || totalAcceleration < 0.5) return;
            
            const note = frequencyToNote(frequency);
            
            // √âviter de jouer trop de notes simultan√©ment
            if (noteTimeout)
